<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Racer V2</title>
    <style>
        /* Grundlayout verhindert Scrollen und Zoomen auf iPad */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #111; 
            font-family: sans-serif; 
            touch-action: none; /* WICHTIG für iPad */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        /* HUD */
        #score-box { position: absolute; top: 20px; left: 20px; color: #fff; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;}

        /* Lade-Bildschirm & Fehler */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; text-align: center;
            z-index: 100; pointer-events: none;
        }

        /* Start Button */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; pointer-events: auto;
        }
        button {
            background: linear-gradient(45deg, #ff0055, #ff00aa);
            border: none; padding: 20px 50px; color: white; font-size: 24px; border-radius: 30px;
            box-shadow: 0 0 20px #ff0055; cursor: pointer;
        }

        /* STEUERUNG (Unten am Bildschirm) */
        #controls-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 180px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: auto; /* Damit man klicken kann */
            padding: 0 20px; box-sizing: border-box;
            z-index: 20;
        }

        /* Buttons */
        .control-btn {
            width: 80px; height: 80px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            color: white; font-size: 30px;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .control-btn:active { background: rgba(0, 255, 255, 0.5); border-color: cyan; }

        #gas-btn {
            width: 100px; height: 100px;
            background: rgba(0, 255, 0, 0.2);
            border-color: #0f0;
            margin-bottom: 20px;
        }
        #gas-btn:active { background: rgba(0, 255, 0, 0.6); }

        #steer-container { display: flex; gap: 20px; margin-bottom: 20px; }

    </style>
</head>
<body>

    <div id="loading">Lade 3D Engine...<br><span style="font-size:14px; color:#aaa;">(Internetverbindung erforderlich)</span></div>

    <div id="start-overlay" style="display:none;">
        <h1 style="color:white; margin-bottom:20px;">NEON RACER</h1>
        <button id="start-btn">SPIEL STARTEN</button>
        <p style="color:#aaa; margin-top:20px;">Links lenken | Rechts Gas geben</p>
    </div>

    <div id="ui-layer">
        <div id="score-box">SCORE: <span id="score">0</span></div>
    </div>

    <div id="controls-area">
        <div id="steer-container">
            <div class="control-btn" id="btn-left">←</div>
            <div class="control-btn" id="btn-right">→</div>
        </div>
        <div class="control-btn" id="gas-btn">GAS</div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>

    <script>
        // --- FEHLERÜBERPRÜFUNG ---
        window.onload = function() {
            if (typeof THREE === 'undefined') {
                document.getElementById('loading').innerHTML = 
                    "<span style='color:red'>FEHLER:</span><br>Konnte 3D-Engine nicht laden.<br>Bitte prüfe deine Internetverbindung.";
                return;
            }
            // Wenn Three.js da ist, Spiel initialisieren
            document.getElementById('loading').style.display = 'none';
            document.getElementById('start-overlay').style.display = 'flex';
            initGame();
        };

        // --- SPIEL VARIABLEN ---
        let scene, camera, renderer, car, grid;
        let obstacles = [];
        let isPlaying = false;
        let score = 0;
        
        // Physik
        let speed = 0;
        const MAX_SPEED = 2.0;
        const ACCEL = 0.05;
        const DRAG = 0.98; // Reibung
        
        // Steuerung
        const inputs = { left: false, right: false, gas: false };

        function initGame() {
            // 1. Szene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.Fog(0x000000, 10, 80);

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, -8);
            camera.lookAt(0, 0, 10);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 4. Licht
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xff00ff, 0.8); // Pinkes Licht
            dirLight.position.set(5, 10, 0);
            scene.add(dirLight);

            // 5. Boden (Endloses Gitter)
            const gridHelper = new THREE.GridHelper(2000, 200, 0x00ffff, 0x222222);
            grid = gridHelper;
            scene.add(grid);

            // 6. Das Auto (Einfacher Block für Performance)
            const geometry = new THREE.BoxGeometry(1.5, 0.8, 3);
            const material = new THREE.MeshPhongMaterial({ color: 0x00ffff, shininess: 100 });
            car = new THREE.Mesh(geometry, material);
            car.position.y = 0.4;
            scene.add(car);

            // Rücklichter
            const tailGeo = new THREE.BoxGeometry(1.4, 0.2, 0.1);
            const tailMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const tail = new THREE.Mesh(tailGeo, tailMat);
            tail.position.set(0, 0.5, -1.5);
            car.add(tail);

            // Hindernisse erzeugen
            for(let i=0; i<20; i++) spawnObstacle(30 + i * 20);

            // Inputs aktivieren
            setupInputs();

            // Loop starten
            animate();
        }

        function spawnObstacle(zDist) {
            const geo = new THREE.BoxGeometry(2, 4, 2);
            const mat = new THREE.MeshBasicMaterial({ color: 0xff0055, wireframe: true });
            const obs = new THREE.Mesh(geo, mat);
            obs.position.x = (Math.random() - 0.5) * 60; // Zufällige X Position
            obs.position.y = 2;
            obs.position.z = zDist;
            scene.add(obs);
            obstacles.push(obs);
        }

        function setupInputs() {
            // Touch Logik
            const addTouch = (id, key) => {
                const el = document.getElementById(id);
                el.addEventListener('touchstart', (e) => { e.preventDefault(); inputs[key] = true; });
                el.addEventListener('touchend', (e) => { e.preventDefault(); inputs[key] = false; });
                // Maus Support für PC Tests
                el.addEventListener('mousedown', () => inputs[key] = true);
                el.addEventListener('mouseup', () => inputs[key] = false);
            };

            addTouch('btn-left', 'left');
            addTouch('btn-right', 'right');
            addTouch('gas-btn', 'gas');

            // Start Button
            const startBtn = document.getElementById('start-btn');
            startBtn.addEventListener('click', () => {
                document.getElementById('start-overlay').style.display = 'none';
                isPlaying = true;
                
                // Audio Context Hack für iOS (Sound später möglich)
            });
        }

        function update() {
            if(!isPlaying) return;

            // Gasgeben
            if(inputs.gas) {
                speed += ACCEL;
            } else {
                speed *= DRAG;
            }
            speed = Math.min(Math.max(speed, 0), MAX_SPEED);

            // Lenken (nur wenn man fährt)
            if(speed > 0.1) {
                if(inputs.left) {
                    car.position.x += 0.4;
                    car.rotation.z = -0.1; // Neigung
                } else if(inputs.right) {
                    car.position.x -= 0.4;
                    car.rotation.z = 0.1;
                } else {
                    car.rotation.z = 0;
                }
            }

            // Bewegung simulieren (Kamera & Boden bewegen sich, Auto bleibt optisch mittig)
            // Wir bewegen eigentlich die Welt am Auto vorbei
            const forwardSpeed = speed * 2;
            
            // Hindernisse bewegen
            obstacles.forEach(obs => {
                obs.position.z -= forwardSpeed;
                
                // Kollision
                if(obs.position.z < 2 && obs.position.z > -2) {
                    if(Math.abs(obs.position.x - car.position.x) < 2) {
                        // Crash!
                        speed = -0.5;
                        document.getElementById('score').style.color = 'red';
                        setTimeout(() => document.getElementById('score').style.color = 'white', 200);
                    }
                }

                // Reset wenn vorbei
                if(obs.position.z < -20) {
                    obs.position.z = 200;
                    obs.position.x = (Math.random() - 0.5) * 60;
                    score += 10;
                    document.getElementById('score').innerText = score;
                }
            });

            // Gitter Boden Effekt
            grid.position.z -= forwardSpeed;
            if(grid.position.z < -100) grid.position.z = 0;
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
